<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Personal blog of Edgar Aroutiounian">
    <meta name="author" content="Edgar Aroutiounian">
    <title>hyegar.com - Home</title>
    <link rel="canonical" href="http://hyegar.com">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="./css/main.css">
    <link href="./atom.xml" rel="alternate" title="hyegar.com - A personal and developer blog" type="application/atom+xml">
    <link type="text/plain" rel="author" href="./humans.txt">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-57031124-1', 'auto');
      ga('send', 'pageview');
    </script>

  </head>

  <body>
    <header id="page_header">
    <h1><a href="./" title="Home">Edgar Aroutiounian</a></h1>
</header>

    <nav id="page_navigation">
    <ul>
        <li><a href="./">Home</a></li>
        <li><a href="./about">About</a></li>
        <li><a href="./archive">Archive</a></li>
        <li><a href="./resume">Resume</a></li>
    </ul>
</nav>

    
    <section id="content">
      <article>
    <header>
        <h1>
            <a href="./2017/02/12/excellence-security-culture-armenia/" title="Permalink">
                Hacks, cracks, dev culture and Armenia's development in tech üá¶üá≤
            </a>
        </h1>
        <span class="post-date">February 12, 2017</span> in 
        <span class="post-tags"><a href="./tags/armenia/">armenia</a>, <a href="./tags/security/">security</a>, <a href="./tags/development/">development</a>, <a href="./tags/economics/">economics</a></span>
    </header>
    <h3 id="audience">Audience</h3>
<hr />
<p>This post is intended for both technical and non-technical people; its for people interested in the development of programmers, cultures of professionalism, security, and the development of Armenia as a tech power. Along the way I will show some security vulnerabilities of well-known sites in Armenia, non-technical people will be able to follow along as everything will be explained. I will also introduce the concept of a bug bounty exchange.</p>
<p>A glossary of technical terms follows the post, might be worth while to read through those terms first.</p>
<p><strong>I want to emphasis that the point of this blog post is not to shame or make fun of any individual or company, rather it is meant to bring attention to the tech industry, culture in Armenia and what can be done to further it to a higher average level of excellence and professionalism.</strong></p>
<h3 id="problem">Problem</h3>
<hr />
<p>Specifically, with respect to Armenia, much has been said about the tech as a shining example of an honest and rapidly growing industry. However, in my view much of that has been pushed by people who frankly are little connected to the tech industry writ tech itself. There are not enough voices heard from the down in the trenches folks who can provide a truly informed voice.</p>
<p>Armenia‚Äôs geopolitical situation being what it is makes the tech industry arguably of high interest to national security as:</p>
<ol style="list-style-type: decimal">
<li>A robust engine of sustained, organic economic growth. A nation cannot wage wars or devote high levels of resources to its military without a resilient economy. A strong economy lets us negotiate with our enemies from a position of strength.</li>
<li>As a nursery and pipeline for cyber-security. Armenians are disproportionality effective in every domain, the digital realm amplifies that 100X.</li>
</ol>
<p>For the development of countries, it is better to see a country of makers and not outsourcers. Why? Because making products, like Uber, Facebook, etc, is what makes the biggest bucks of all and is best able to utilize the Armenian people‚Äôs creative talents. Working as outsourcing tends to make decent but soulless products, and such products are made by programmers who simply don‚Äôt care about what they‚Äôre making beyond the salary paid. (Hardly eudaimonia)</p>
<p>With that, Armenia has a lot of outsourcing but the product scene is coming along nicely although we haven‚Äôt even seen our first largish failure yet.</p>
<p>Here are two intertwined things I see in the Armenian tech scene that need more attention &amp; sustained improvement.</p>
<div style="display: inline-flex;justify-content: center;width: 100%;">
<table>
<thead>
<tr class="header">
<th>Problem</th>
<th align="center">Fixable</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Hacker, developer culture lagging</td>
<td align="center"><strong>Yes</strong></td>
<td>Invest more in people</td>
</tr>
<tr class="even">
<td>Cyber-security</td>
<td align="center"><strong>Yes</strong></td>
<td>Invest more in people</td>
</tr>
</tbody>
</table>
</div>
<p>What do I mean by developer culture? In a way, it‚Äôs like professionalism in other fields which is characterized by devotion to your craft, not cutting corners, doing things the right way even when it takes longer and deeply learning the tools of your craft. Sometimes in Armenian culture people like to cut corners, this is a fact. Examples include cutting corners in Gyumri‚Äôs apartment construction which led to worse outcomes in the 1988 earthquake to the elevator in my building whose buttons were always off by one. There‚Äôs an implicit acceptance of a shrugging your shoulders quality work and it is reflected in the tech industry as well.</p>
<h3 id="examples-of-shortcoming">Examples of shortcoming</h3>
<hr />
<p>Now let‚Äôs look at a few examples of the manifestations of these shortcomings. I will now show you three examples of live web vulnerabilities of three sites in Armenia, each of which was told that a problem existed but didn‚Äôt pursue a fix initially although one has been fixed. All three of them are the result of similar entry level mistakes.</p>
<p>I found out about these exploits after first posting in the Facebook iterate chatroom about bots attacking <a href="https://silicondzor.com">silicondzor.com</a></p>
<div style="display: inline-flex;justify-content: center;width: 100%;">
<div class="figure">
<img src="./images/bots.png" />

</div>
</div>
<p>This image is from a server log for <code>silicondzor.com</code>. See the line <code>GET /.git/ HTTP/1.1</code>? That‚Äôs a bot checking if it can get our entire git repo, all our source code. After posting that, <code>Sparik Hayrapetyan</code> reached out to me and reported some Armenian sites that were vulnerable to this very exploit!</p>
<p>I verified some of those site and here are how damning it is‚Ä¶</p>
<p>Say we have three websites each ending in a <code>.am</code> TLD:</p>
<p><em>(the creator field is from attributes given on the public facing sites)</em></p>
<div style="display: inline-flex;justify-content: center;width: 100%;">
<table>
<thead>
<tr class="header">
<th>Site</th>
<th align="center">Subject matter</th>
<th>exploit</th>
<th>creator</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>siteA</td>
<td align="center">auction</td>
<td>Full git repo, found credentials</td>
<td><a href="http://voodoo.pro/en" class="uri">http://voodoo.pro/en</a></td>
</tr>
<tr class="even">
<td>siteB</td>
<td align="center">car rental</td>
<td>Full git repo, found credentials</td>
<td>sitemax</td>
</tr>
<tr class="odd">
<td>siteC</td>
<td align="center">reading materials</td>
<td>Full git repo</td>
<td><a href="https://www.studio-one.am" class="uri">https://www.studio-one.am</a></td>
</tr>
</tbody>
</table>
</div>
<p>What does it mean to have the full git repo? It means to have the entire history of the source code from beginning to end.</p>
<p>Verification pics:</p>
<h3 id="sitea-the-auction-site">SiteA ‚Äì the auction site</h3>
<p>First about the programmer culture, this particular code base uses PHP. A programming language known to be inherently defective in security and one that is usally avoided for new projects in Silicon Valley.</p>
<div style="display: inline-flex;justify-content: center;width: 100%;">
<div class="figure">
<img src="./images/generated-code-site-a.png" />

</div>
</div>
<p>Not only are they using PHP, they are also using an IDE to <strong>generate</strong> PHP code.</p>
<p>Another bad practice they have their passwords in the source code. Hint: this is never a good idea. Since as an auction site they are handling all kinds of credit cards and other sensitive information and now any attacker, including me potentially have access to it all. (Programmers: A better solution is to use environment variables)</p>
<div style="display: inline-flex;justify-content: center;width: 100%;">
<div class="figure">
<img src="./images/credentials-site-a.png" />

</div>
</div>
SiteA also exposed their <strong>SQL</strong> on the public website
<div style="display: inline-flex;justify-content: center;width: 100%;">
<div class="figure">
<img src="./images/sql-dumped.png" />

</div>
</div>
<h3 id="siteb-car-rental-site">SiteB ‚Äì Car rental site</h3>
<p>The car rental site required a little bit more work to reconstruct the original git repo. Thankfully using tools like <a href="https://github.com/internetwache/GitTools">GitTools</a> makes the process painless and after some searching through the source code I found this goodie. These are credentials to the database which being a car rental site also probably contains some nice credit card numbers, accounts.</p>
<div style="display: inline-flex;justify-content: center;width: 100%;">
<div class="figure">
<img src="./images/site-b-mysql-creds.png" />

</div>
</div>
<h3 id="sitec-reading-materials">SiteC ‚Äì Reading materials</h3>
<p>I didn‚Äôt dig too deeply in this repo but here‚Äôs an example structure. The indentation means hierarchy of directories and files, things ending in <code>.php</code> are source code files.</p>
<div style="display: inline-flex;justify-content: center;width: 100%;">
<div class="figure">
<img src="./images/site-c.png" />

</div>
</div>
<p>Studio-One proudly boasts of its clients including <code>AmeriaBank</code> and the <code>National Assembly of RA</code>. How much do you want to bet that they do similar sloppy coding across all these projects?</p>
<div style="display: inline-flex;justify-content: center;width: 100%;">
<div class="figure">
<img src="./images/site-c-boast.png" />

</div>
</div>
<p>Again this exploit was rather simple, it was a rookie mistake.</p>
<h3 id="bug-bounties">Bug Bounties</h3>
<p>Now as I mentioned Sparik first reported exploits to the respective site owners but amazingly some didn‚Äôt even reply or simply asked him leave his email address, the de facto equivalent of ‚ÄúDon‚Äôt call us, we‚Äôll call you‚Äù. Amazingly Sparik wasn‚Äôt compensated at all or recognized! I reached out as well but only one replied and has since fixed the mistakes.</p>
<p>Many other companies would have paid him under a system called a <code>bug bounty</code>. This is when companies pay whoever finds exploits on their website/app/program under a structured disclosure method. The idea is that it is better for the company to pay to know about the exploit, fix it, and move on rather than have the exploit end up on the black market and then hit them out in the wild. An example of this is the Target hacking, that cost over $100 Million in damages. Facebook has been running their bug bounty since 2011 with great success, some payouts reach $40,000 which is still substantially less than what can happen when someone malicious literally has all the passwords to your databases and computers. To my knowledge, there are no companies in Armenia that run a bug bounty.</p>
<h3 id="mitigation">Mitigation</h3>
<p>How can we mitigate these kinds of exploits? Well in a way its simple but also hard &amp; vague; we do it by:</p>
<ol style="list-style-type: decimal">
<li><p>Promoting a culture of people open about knowledge, about promoting collerboration. This particular exploit is talked about in just about every other InfoSec meetup in San Francisco and is well known but in Armenia a seemingly prominent firm is repeatedly making it. Practically speaking this means more meetups. A check on <a href="https://silicondzor.com">silicondzor.com</a> shows 53 events in Feburary for Armenia, that number needs to be higher and a higher percentage needs to be programmers talking to other programmers, not fluff sessions about Marketing/Startups. The meetups should lean toward being workshops with hands on examples and live coding.</p></li>
<li><p>Sponsoring bug bounties, especially starting with Government &amp; military websites.</p></li>
<li><p>Having more events like the recent <a href="https://www.facebook.com/events/642338025891387">Capture the Flag</a> which literally included the exploit used in this blog post.</p></li>
<li><p>Promoting a culture of professionalism &amp; respect for programmers. Programmers are not respected as crafts people in Armenia.</p></li>
<li><p>Collective funding of talent. The entire Armenian tech industry needs to be willing to spend some money on the collective pool of talent. This means like non-trivial prizes for hackathon, paid bug bounties, paid trainings Armenian culture in general does not promote doing things for free, or helping someone without expecting something in return implicitly.</p></li>
<li><p>Promoting and funding projects that protect critical internet infrastructure for Armenia, like <a href="https://www.trusted-introducer.org/directory/teams/cert-am.html">CERT-AM</a></p></li>
</ol>
<p>Keep in mind that many of these are happening one way or another, I am merely enumerating some for record. Because I believe in <strong>doing</strong> and not merely speaking, I will be creating a public bug bounty exchange for all of Armenia, it will be listed on <a href="https://silicondzor.com">silicondzor.com</a>. Once it is up, I encourage all companies, not just tech companies, to post on the bug bounty exchange with offers of payment for successful examples of exploits.</p>
<h3 id="parting">Parting</h3>
<p>(While writing this post a new story broke out of crackers attacking Armenian banks, <a href="http://hetq.am/eng/news/75680/hackers-infiltrate-computer-system-of-bank-in-armenia-steal-$273000.html">Hackers Infiltrate Computer System of Bank in Armenia; Steal $273,000</a>, I think you could see the connections of what I‚Äôm trying to say; forget criminals for a moment and now imagine a nation-state determined to destroy us.)</p>
<p>There is a lot of hype and excitement for tech in Armenia and it holds a huge promise, but we must grow our industry, talent correctly. In addition, because the topic is Armenia, we must keep in mind about security as cyber-security is increasingly the first line of attack and defense in war. Would our enemies be so kind as to tell us about exploits on our banking sites? Or perhaps military sites or other critical government? What about the electrical system or other critical infrastructure that is increasingly connected to the internet. How effective are <code>Iskanders</code> when someone hacks and reprograms them mid-flight? These questions show the level to which tech, economy and national security are all interrelated in Armenia and the level of responsibility the tech industry has to Armenia.</p>
<h3 id="glossary">Glossary</h3>
<p>Note:</p>
<ol style="list-style-type: decimal">
<li>Non-technical people, you should probably start learning the jargon.</li>
<li>Technical people, these are loose definition meant for intuition rather than accuracy.</li>
</ol>
<p><strong>source code</strong>: The original code of a program, written by a programmer. This can be publicably available or private, usually when its private then it has things like passwords written in it.</p>
<p><strong>exploit</strong>: A mistake in the source code which then lets another person use that mistake to cause a program to do something other than originally intended. I.E. if I find an exploit in the ATM machine, then maybe I can get it to spit out money.</p>
<p><strong>InfoSec</strong>: Short for information security, its a subfield of programming culture and include a focus on security.</p>
<p><strong>cracker</strong>: A professional hacker who attacks programs, products for money usually.</p>
<p><strong>pentest</strong>: Short for penetration testing, its when you pay a infosec professional to attack your product as if they were a cracker.</p>
<p><strong>DDoS</strong>: This is when someone abuses whatever service you are providing by overwhelming you with too many requests for that service thereby bringing the whole system down.</p>
<p><strong>git</strong>: A program used by programmers to help them keep track of all the source code they write, down to the detail of which line of code was written by whom, when.</p>
<p><strong>repo</strong>: A directory on the hard drive of a computer created by the git program. It contains all the source code and whatever else the programmers decided to keep track of in the project.</p>
<p><strong>commit</strong>: Something created by git that is like a collection of saves of source code. Think of it like a record in time of how the source code look like.</p>
<p><strong>TLD</strong>: Top level domain, basically the <code>.com</code> or <code>.am</code> part of a website name.</p>
<p><strong>IDE</strong>: A program that some programmers use to help them make new programs, think of it like a fancy word processor with auto completion.</p>
<p><strong>SQL</strong>: A programming language designed for databases. If I know your SQL then I know how your data is organized, stored, and what I should be looking for once I get into your system.</p>
<p><strong>bots</strong>: Computer programs designed to do boring, repetitive things. In this post it refers to programs designed to search the web for simple, rookie level exploits.</p>
</article>
<article>
    <header>
        <h1>
            <a href="./2017/01/10/small-ocaml-object-annoyance/" title="Permalink">
                let binding in OCaml class definition
            </a>
        </h1>
        <span class="post-date">January 10, 2017</span> in 
        <span class="post-tags"><a href="./tags/ocaml/">ocaml</a>, <a href="./tags/objects/">objects</a>, <a href="./tags/mistakes/">mistakes</a></span>
    </header>
    <p>I like the <code>object</code> layer in OCaml but here‚Äôs one quirk of the language that sometimes I forget about and it can bite you‚Ä¶like I just got bit in my <code>OCaml</code> <a href="https://github.com/fxfactorial/ocaml-java-scriptengine">bindings</a> to <code>Java</code>‚Äôs <code>ScriptEngine</code>. (Let‚Äôs you evaluate <code>JavaScript</code> in <code>OCaml</code> using the JVM)</p>
<p>OCaml lets you define an object like so:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing = <span class="kw">object</span>
  <span class="kw">method</span> speak = <span class="dt">print_endline</span> <span class="st">&quot;Hello&quot;</span>
<span class="kw">end</span>

<span class="kw">let</span> () = (<span class="kw">new</span> thing)#speak</code></pre></div>
<p>Note that <code>method</code>s don‚Äôt need arguments, they will always go off when you call them.</p>
<p>and you can also have fields</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing = <span class="kw">object</span>
  <span class="kw">val</span> coder = <span class="st">&quot;coder&quot;</span>
  <span class="kw">val</span> <span class="kw">mutable</span> name = <span class="st">&quot;Edgar&quot;</span>

  <span class="kw">method</span> speak = <span class="dt">print_endline</span> (name ^ coder)
  <span class="kw">method</span> set_name s = name &lt;- s
<span class="kw">end</span>

<span class="kw">let</span> () = 
  <span class="kw">let</span> p = <span class="kw">new</span> thing <span class="kw">in</span>
  p#speak;
  p#set_name <span class="st">&quot;Gohar&quot;</span>;
  p#speak</code></pre></div>
<p>Notice that we can also make fields <code>mutable</code> and they are private by default.</p>
<p>Now here‚Äôs one situation you might encounter:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> compute = <span class="kw">object</span>
  <span class="kw">val</span> first_field = Other_module.init ()
  <span class="kw">val</span> second_field = Some_module.use_it first_field
<span class="kw">end</span></code></pre></div>
<p>This won‚Äôt work though because you can‚Äôt use one field in another field.</p>
<p>One solution might be:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml">
<span class="kw">class</span> compute = 

  <span class="kw">let</span> first_field = Other_module.init () <span class="kw">in</span>
  <span class="kw">let</span> second_field = Some_module.use_it first_field <span class="kw">in</span>
  <span class="kw">object</span>
    <span class="kw">val</span> first = first_field
    <span class="kw">val</span> second = second_field
  <span class="kw">end</span></code></pre></div>
<p>Now question, are <code>first_field</code> and <code>second_field</code> created each time a new instance of <code>compute</code> is made?</p>
<p>‚Ä¶</p>
<p>The answer is no and this might be counter intuitive to some, at least it was to me and I sometimes forget this.</p>
<p>Verify it with:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing =
  <span class="kw">let</span> foo = <span class="dv">1</span> + <span class="dv">2</span> <span class="kw">in</span>
  <span class="kw">let</span> () = <span class="dt">print_endline</span> <span class="st">&quot;I was called&quot;</span> <span class="kw">in</span>
  <span class="kw">object</span>

  <span class="kw">end</span>


<span class="kw">let</span> () =
  <span class="kw">let</span> a = <span class="kw">new</span> thing <span class="kw">in</span>
  <span class="kw">let</span> b = <span class="kw">new</span> thing <span class="kw">in</span>
  ()</code></pre></div>
<p>And see how many times <code>I was called</code> is printed to the screen; hence be aware of this when you use objects in OCaml.</p>
</article>
<article>
    <header>
        <h1>
            <a href="./2017/01/09/calling-google-closure/" title="Permalink">
                Calling Google Closure programmatically
            </a>
        </h1>
        <span class="post-date">January  9, 2017</span> in 
        <span class="post-tags"><a href="./tags/java/">java</a>, <a href="./tags/google%20closure/">google closure</a>, <a href="./tags/api/">api</a></span>
    </header>
    <p>This is a pretty neat post, I‚Äôll show you how to programmatically call <a href="https://github.com/google/closure-library">Google Closure</a> in Java. Closure is an amazing project that actually optimizes <code>JavaScript</code> rather than just minifies it. (This is pretty much one of the few times you‚Äôll see me write Java, I think the language sucks).</p>
<p>Its mostly a 2017 update of this <a href="http://blog.bolinfest.com/2009/11/calling-closure-compiler-from-java.html">post from 2009</a></p>
<p>Here‚Äôs the Java</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java"><span class="kw">package</span><span class="im"> com.hyegar.closure;</span>

<span class="kw">import</span><span class="im"> java.io.IOException;</span>
<span class="kw">import</span><span class="im"> java.util.List;</span>
<span class="kw">import</span><span class="im"> java.util.ArrayList;</span>

<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.CompilationLevel;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.Compiler;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.CompilerOptions;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.SourceFile;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.CommandLineRunner;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.CompilerOptions.LanguageMode;</span>

<span class="co">/**</span>
<span class="co"> * An example of how to call the Closure Compiler programmatically, </span>
<span class="co"> * this is LICENSED AS GPL-3.0.</span>
<span class="co"> *</span>
<span class="co"> * </span><span class="kw">@author </span><span class="co">edgar.factorial@gmail.com (Edgar Aroutiounian)</span>
<span class="co"> */</span>

<span class="kw">public</span> <span class="kw">class</span> CallCompiler {

    <span class="co">/**</span>
<span class="co">     * </span><span class="kw">@param code </span><span class="co">JavaScript source code to compile.</span>
<span class="co">     * </span><span class="kw">@return </span><span class="co">The compiled version of the code.</span>
<span class="co">     */</span>
    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> <span class="fu">compile</span>(<span class="bu">String</span> code) {
	<span class="bu">Compiler</span> compiler = <span class="kw">new</span> <span class="bu">Compiler</span>();

	CompilerOptions options = <span class="kw">new</span> <span class="fu">CompilerOptions</span>();

	<span class="co">// See :</span>
	<span class="co">// closure-compiler/src/com/google/javascript/jscomp/CompilerOptions.java</span>
	<span class="co">// lines 2864-2896</span>
	options.<span class="fu">setLanguageIn</span>(LanguageMode.<span class="fu">ECMASCRIPT_2015</span>);
	options.<span class="fu">setLanguageOut</span>(LanguageMode.<span class="fu">ECMASCRIPT5_STRICT</span>);

	CompilationLevel
	    .<span class="fu">ADVANCED_OPTIMIZATIONS</span>
	    .<span class="fu">setOptionsForCompilationLevel</span>(options);

	<span class="bu">List</span>&lt;SourceFile&gt; list = <span class="kw">null</span>;

	<span class="kw">try</span> {
	    list =
		CommandLineRunner
		.<span class="fu">getBuiltinExterns</span>(CompilerOptions.<span class="fu">Environment</span>.<span class="fu">BROWSER</span>);
	} <span class="kw">catch</span> (<span class="bu">IOException</span> e) {
	    <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Exception raised&quot;</span>);
	}

	list.<span class="fu">add</span>(SourceFile.<span class="fu">fromCode</span>(<span class="st">&quot;input.js&quot;</span>, code));
	compiler.<span class="fu">compile</span>(<span class="kw">new</span> <span class="bu">ArrayList</span>&lt;SourceFile&gt;(), list, options);
	<span class="kw">return</span> compiler.<span class="fu">toSource</span>();
    }

    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(<span class="bu">String</span>[] args) {
      <span class="bu">String</span> compiled_code = <span class="fu">compile</span>(<span class="st">&quot;var a = 1 + 2; console.log(a)&quot;</span>);
      <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(compiled_code);
    }

}</code></pre></div>
<p>You‚Äôll need to have the Closure Compiler installed, on OS X this is easy with <code>brew install closure-compiler</code></p>
<p>Then in a new directory that you can use for this build, you can copy the <code>jar</code> from <code>/usr/local/Cellar/closure-compiler/20161201/libexec</code> to where the root is of your directory, let‚Äôs call that directory <code>build</code>.</p>
<p>Here‚Äôs a Makefile which will build, run the code.</p>
<div class="sourceCode"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span class="dv">blog_code:</span>
	javac -Xlint:deprecation -cp ./closure-compiler-v20161201.jar:./ com/hyegar/closure/CallCompiler.java
	java -cp ./closure-compiler-v20161201.jar:./ com.hyegar.closure.CallCompiler	</code></pre></div>
</article>
<article>
    <header>
        <h1>
            <a href="./2017/01/08/variants-in-cpp/" title="Permalink">
                variants in C++14 without boost
            </a>
        </h1>
        <span class="post-date">January  8, 2017</span> in 
        <span class="post-tags"><a href="./tags/variants/">variants</a>, <a href="./tags/C%2B%2B/">C++</a>, <a href="./tags/C%2B%2B14/">C++14</a></span>
    </header>
    <h1 id="variants-in-their-native-land">Variants in their native land</h1>
<p>One of the best parts of functional programming are <code>Algebraic Data Types</code>, also known as <code>Sum</code> types, also known as <code>variants</code>. They help you make more type safe programs, self-documenting code.</p>
<p>Here are some examples in <code>OCaml</code></p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">type</span> 'a <span class="dt">option</span> = <span class="dt">Some</span> <span class="kw">of</span> 'a | <span class="dt">None</span></code></pre></div>
<p>This is the famous option type of functional programming. A fun thing about option is that its also a Monad, so <code>&gt;&gt;=</code> aka <code>bind</code> is easily defined as:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> ( &gt;&gt;= ) x f = <span class="kw">match</span> x <span class="kw">with</span> <span class="dt">Some</span> h -&gt; f h | _ -&gt; <span class="dt">None</span></code></pre></div>
<p>Another example recently added to the OCaml standard library is the result type.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">type</span> ('success, 'failure) result = Ok <span class="kw">of</span> 'success | Error <span class="kw">of</span> 'failure</code></pre></div>
<p>The things prefixed with <code>'</code> are called type variables, they let you write generic code from the getgo. We only need one for <code>option</code> but we need two different ones for result so that the type of the <code>Ok</code> variant need not be the same as the type of the <code>Error</code> variant.</p>
<p>Once you get an <code>result</code> value, you can pattern match on it:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> process_result = <span class="kw">function</span> 
  | Ok r -&gt; <span class="co">(* Do something with r *)</span>
  | Error reason -&gt; <span class="co">(* Do something with the error *)</span></code></pre></div>
<h1 id="variants-in-c">variants in C++</h1>
<p>In <code>C++</code> variants are not first class citizens of the language, so they need to be provided by a library. In modern <code>C++</code> our options are <code>C++17</code>‚Äôs <code>std::variant</code>, <code>boost::variant</code> or someone‚Äôs own rolled version.</p>
<p>I don‚Äôt want the <code>boost</code> dependency and I can‚Äôt use <code>C++17</code> so I looked for a library implementation. I found one by <a href="https://github.com/mapbox/variant">mapbox</a> and it fit my usecase perfectly; its a header only template library and I like the API provided. Here‚Äôs my implementation of <code>option</code> using the <code>mapbox</code> variant library.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// Let's assume this file is named optional.hpp</span>
<span class="pp">#pragma once</span>

<span class="pp">#include </span><span class="im">&lt;mapbox/variant.hpp&gt;</span>

<span class="kw">namespace</span> optional {
  <span class="kw">struct</span> None { };
  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;
  <span class="kw">struct</span> Some { T payload; };

  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;
  <span class="kw">struct</span> Optional : mapbox::util::variant&lt;None, Some&lt;T&gt;&gt; {
    <span class="kw">using</span> Base = mapbox::util::variant&lt;None, Some&lt;T&gt;&gt;;
    <span class="kw">using</span> Base::Base;
  };

  <span class="co">// These two are helper functions, like std::make_unique, etc.</span>
  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;
  <span class="kw">auto</span> some(T x)  { <span class="cf">return</span> Optional&lt;T&gt;{Some&lt;T&gt;{x}}; }

  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;
  <span class="kw">auto</span> none(<span class="dt">void</span>) { <span class="cf">return</span> Optional&lt;T&gt;{None{}}; }

}</code></pre></div>
<p>And here‚Äôs an example usage:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// Let's assume this file is named main.cpp</span>
<span class="pp">#include </span><span class="im">&lt;string&gt;</span>
<span class="pp">#include </span><span class="im">&lt;iostream&gt;</span>

<span class="pp">#include </span><span class="im">&quot;optional.hpp&quot;</span>

<span class="co">// This lets just make std::string just by adding a suffix of 's'</span>
<span class="co">// to things that otherwise look like char *</span>
<span class="kw">using</span> <span class="kw">namespace</span> <span class="bu">std::</span>literals<span class="bu">::</span>string_literals;

<span class="co">// Pretend that this is something that could fail.</span>
<span class="kw">auto</span> file_contents(<span class="dt">void</span>) {
  <span class="cf">return</span> optional::some(<span class="st">&quot;some file contents&quot;</span>s);
}

<span class="dt">int</span> main(<span class="dt">void</span>)
{
  file_contents()
    .match(
  	   [](optional::None) {
  	     <span class="bu">std::</span>cout &lt;&lt; <span class="st">&quot;Check if file existed</span><span class="sc">\n</span><span class="st">&quot;</span>;
  	   },
  	   [](<span class="kw">auto</span> some) {
  	     <span class="bu">std::</span>cout &lt;&lt; <span class="st">&quot;File contents: &quot;</span> &lt;&lt; some.payload;
  	   });
}</code></pre></div>
<p>and you can easily compile it with, assuming that you added mapbox/variant.hpp to your compiler‚Äôs include search path‚Ä¶</p>
<pre class="shell"><code>$ clang++ -std=c++14 main.cpp</code></pre>
<p>Happy coding.</p>
</article>
<article>
    <header>
        <h1>
            <a href="./2016/12/23/async-promises-node/" title="Permalink">
                node's async, await, Promises.
            </a>
        </h1>
        <span class="post-date">December 23, 2016</span> in 
        <span class="post-tags"><a href="./tags/async/">async</a>, <a href="./tags/lwt/">lwt</a>, <a href="./tags/await/">await</a>, <a href="./tags/async/">async</a>, <a href="./tags/promises/">promises</a></span>
    </header>
    <p>While studying for interviews I‚Äôm talking breaks by working on <a href="https://github.com/fxfactorial/silicondzor">silicondzor.com</a></p>
<p>This is giving me some real web dev experience and I‚Äôm using the latest and greatest features of <code>JavaScript</code> and <code>node</code>.</p>
<p>One thing that I‚Äôm really liking in modern <code>JavaScript</code> is the <code>async</code> story, it reminds me a lot of <code>OCaml</code> and both are somewhat converging, i.e <code>ES6</code>‚Äôs introduction of Promises which are basically <code>'a Lwt.t</code>, and Lwt renaming <code>Lwt.t</code> into Promises in <code>2.7.0</code>.</p>
<p>Here‚Äôs like my conceptual cheatsheet about using <code>Promises</code> from scratch, converting an callback API into a <code>Promises</code> API and then taking it to the next step with <code>async</code>, <code>await</code>.</p>
<h1 id="basic-callback-apis">Basic callback APIs</h1>
<p><code>node</code> uses an event based programming paradigm and this is reflected in basically all server side code, ie the trailing callback argument to asynchronously call once the task completes.</p>
<p>Let‚Äôs simulate it with this function</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Plain CB based API</span>
<span class="kw">const</span> test_func <span class="op">=</span> (item<span class="op">,</span> cb) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="at">setTimeout</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (item <span class="op">&lt;</span> <span class="dv">5</span>) <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="st">'Success'</span>)<span class="op">;</span>
    <span class="cf">else</span> <span class="at">cb</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">'Oops'</span>)<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span>
  <span class="op">},</span> <span class="dv">3000</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="at">test_func</span>(<span class="dv">3</span><span class="op">,</span> (err<span class="op">,</span> success) <span class="op">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(success))<span class="op">;</span></code></pre></div>
<p>This models typical <code>node</code> code, the callback being called <code>three</code> seconds after execution of <code>test_func</code></p>
<p>This seems pretty fine for this example but once you have logic that is dependent on the success of one callback API after another then you start to have a difficult to reason about triangle of callbacks on the screen.</p>
<h1 id="promises">Promises</h1>
<p><code>ES6</code> introduces <code>Promises</code> and these are quite convienent, think of a Promise as being a box which will have a value in it sometime later.</p>
<p>We can turn any callback based API into a Promises based one.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Promises based</span>
<span class="kw">const</span> test_func_promise <span class="op">=</span> item <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((accept<span class="op">,</span> reject) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">test_func</span>(item<span class="op">,</span> (err<span class="op">,</span> success) <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="cf">if</span> (err) <span class="at">reject</span>(err)<span class="op">;</span>
      <span class="cf">else</span> <span class="at">accept</span>(success)<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="at">test_func_promise</span>(<span class="dv">2</span>)
.<span class="at">then</span>(item <span class="op">=&gt;</span> <span class="op">{</span> <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Sucess!!'</span><span class="op">,</span> item)<span class="op">;</span> <span class="op">}</span>)
.<span class="at">catch</span>(err <span class="op">=&gt;</span> <span class="va">console</span>.<span class="at">error</span>(err))<span class="op">;</span></code></pre></div>
<p>When you create a new <code>Promise</code> you need to provide it with two function, one to be called when there‚Äôs a success and when the Promise should fail. Hence when calling <code>test_func_promise</code> returns a Promise, not the value <code>'Success'</code>. Also if you use the plain Promises approach be sure to include a <code>.catch</code> call.</p>
<p>This is nicer than the original callback API approach, but now all your success or failure logic and everything following that effectively has to be all in either <code>.then</code> or <code>.catch</code> and that‚Äôs a bit awkward still.</p>
<h1 id="asyncawait">async/await</h1>
<p><code>ES7</code> introduced <code>async</code>, <code>await</code> where I basically think of the latter as <code>&gt;&gt;=</code> and <code>async</code> as sort of like <code>&gt;|=</code>. With <code>async</code>, <code>await</code> we can call <code>Promises</code> based code as if it was synchronous code.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">const</span> test_func_async_example <span class="op">=</span> <span class="at">async</span> (item) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="cf">try</span> <span class="op">{</span>
    <span class="kw">const</span> result <span class="op">=</span> await <span class="at">test_func_promise</span>(item)<span class="op">;</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Yay: </span><span class="sc">${</span>result<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">catch</span>(e) <span class="op">{</span>
    <span class="va">console</span>.<span class="at">error</span>(<span class="vs">`Messed up: </span><span class="sc">${</span>e<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span>

<span class="at">test_func_async_example</span>(<span class="dv">6</span>)<span class="op">;</span>
<span class="at">test_func_async_example</span>(<span class="dv">3</span>)<span class="op">;</span></code></pre></div>
<p>First notice how whatever function we use <code>await</code> inside of, we need to tag that function with <code>async</code> and now this function returns a <code>Promise</code></p>
<p>Now when we call <code>test_func_promises</code> with <code>await</code> prefixed, then we get the value that the <code>Promise</code> resolved. Also whatever the <code>reject</code> condition of the <code>Promise</code> was then becomes the exception of the <code>catch</code> following the <code>await</code> usage.</p>
<h1 id="summary">Summary</h1>
<p><code>async</code>, <code>await</code> are very powerful features of <code>ES7</code>, <code>Promises</code> are from <code>ES6</code>. Not every <code>JavaScript</code> engine supports <code>ES7</code> so you‚Äôll have to use <code>babel</code> to compile your <code>async</code>, <code>await</code> to runnable code; basically turns the <code>async</code>, <code>await</code> to generators (also an amazing topic).</p>
<p>On newer versions of node, I‚Äôm using <code>v7.3.0</code>, you can turn on features from the future with command line arguments. Check all of them with:</p>
<pre><code>$ node --v8-options | less</code></pre>
<p>I‚Äôm turning on native <code>async</code>, <code>await</code> with <code>--harmony_async_await</code>, so my final invocation is:</p>
<pre><code>$ node --harmony_async_await test.js</code></pre>
<p>You can get all the code as one script <a href="https://gist.github.com/fxfactorial/60edd7c3c8948754d21dbc9f517e37ee">here</a></p>
</article>


<footer>
    See older posts in the <a href="./archive/">archive</a>
</footer>

    </section>

    <footer id="page_footer">
    <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC-4.0</a>
    &mdash;
    Built with 
    <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
    &mdash;
    Source on 
    <a href="https://github.com/fxfactorial/hblog">GitHub</a>
    &mdash;
    <a href="http://hyegar.com/atom.xml">RSS feed</a>
</footer>

  </body>
</html>
