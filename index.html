<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Personal blog of Edgar Aroutiounian">
    <meta name="author" content="Edgar Aroutiounian">
    <title>hyegar.com - Home</title>
    <link rel="canonical" href="http://hyegar.com">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="./css/main.css">
    <link href="./atom.xml" rel="alternate" title="hyegar.com - A personal and developer blog" type="application/atom+xml">
    <link type="text/plain" rel="author" href="./humans.txt">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-57031124-1', 'auto');
      ga('send', 'pageview');
    </script>

  </head>

  <body>
    <header id="page_header">
    <h1><a href="./" title="Home">Edgar Aroutiounian</a></h1>
</header>

    <nav id="page_navigation">
    <ul>
        <li><a href="./">Home</a></li>
        <li><a href="./about">About</a></li>
        <li><a href="./archive">Archive</a></li>
        <li><a href="./resume">Resume</a></li>
    </ul>
</nav>

    
    <section id="content">
      <article>
    <header>
        <h1>
            <a href="./2017/01/10/small-ocaml-object-annoyance/" title="Permalink">
                let binding in OCaml class definition
            </a>
        </h1>
        <span class="post-date">January 10, 2017</span> in 
        <span class="post-tags"><a href="./tags/ocaml/">ocaml</a>, <a href="./tags/objects/">objects</a>, <a href="./tags/mistakes/">mistakes</a></span>
    </header>
    <p>I like the <code>object</code> layer in OCaml but here’s one quirk of the language that sometimes I forget about and it can bite you…like I just got bit in my <code>OCaml</code> <a href="https://github.com/fxfactorial/ocaml-java-scriptengine">bindings</a> to <code>Java</code>’s <code>ScriptEngine</code>. (Let’s you evaluate <code>JavaScript</code> in <code>OCaml</code> using the JVM)</p>
<p>OCaml lets you define an object like so:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing = <span class="kw">object</span>
  <span class="kw">method</span> speak = <span class="dt">print_endline</span> <span class="st">&quot;Hello&quot;</span>
<span class="kw">end</span>

<span class="kw">let</span> () = (<span class="kw">new</span> thing)#speak</code></pre></div>
<p>Note that <code>method</code>s don’t need arguments, they will always go off when you call them.</p>
<p>and you can also have fields</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing = <span class="kw">object</span>
  <span class="kw">val</span> coder = <span class="st">&quot;coder&quot;</span>
  <span class="kw">val</span> <span class="kw">mutable</span> name = <span class="st">&quot;Edgar&quot;</span>

  <span class="kw">method</span> speak = <span class="dt">print_endline</span> (name ^ coder)
  <span class="kw">method</span> set_name s = name &lt;- s
<span class="kw">end</span>

<span class="kw">let</span> () = 
  <span class="kw">let</span> p = <span class="kw">new</span> thing <span class="kw">in</span>
  p#speak;
  p#set_name <span class="st">&quot;Gohar&quot;</span>;
  p#speak</code></pre></div>
<p>Notice that we can also make fields <code>mutable</code> and they are private by default.</p>
<p>Now here’s one situation you might encounter:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> compute = <span class="kw">object</span>
  <span class="kw">val</span> first_field = Other_module.init ()
  <span class="kw">val</span> second_field = Some_module.use_it first_field
<span class="kw">end</span></code></pre></div>
<p>This won’t work though because you can’t use one field in another field.</p>
<p>One solution might be:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml">
<span class="kw">class</span> compute = 

  <span class="kw">let</span> first_field = Other_module.init () <span class="kw">in</span>
  <span class="kw">let</span> second_field = Some_module.use_it first_field <span class="kw">in</span>
  <span class="kw">object</span>
    <span class="kw">val</span> first = first_field
    <span class="kw">val</span> second = second_field
  <span class="kw">end</span></code></pre></div>
<p>Now question, are <code>first_field</code> and <code>second_field</code> created each time a new instance of <code>compute</code> is made?</p>
<p>…</p>
<p>The answer is no and this might be counter intuitive to some, at least it was to me and I sometimes forget this.</p>
<p>Verify it with:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing =
  <span class="kw">let</span> foo = <span class="dv">1</span> + <span class="dv">2</span> <span class="kw">in</span>
  <span class="kw">let</span> () = <span class="dt">print_endline</span> <span class="st">&quot;I was called&quot;</span> <span class="kw">in</span>
  <span class="kw">object</span>

  <span class="kw">end</span>


<span class="kw">let</span> () =
  <span class="kw">let</span> a = <span class="kw">new</span> thing <span class="kw">in</span>
  <span class="kw">let</span> b = <span class="kw">new</span> thing <span class="kw">in</span>
  ()</code></pre></div>
<p>And see how many times <code>I was called</code> is printed to the screen; hence be aware of this when you use objects in OCaml.</p>
</article>
<article>
    <header>
        <h1>
            <a href="./2017/01/09/calling-google-closure/" title="Permalink">
                Calling Google Closure programmatically
            </a>
        </h1>
        <span class="post-date">January  9, 2017</span> in 
        <span class="post-tags"><a href="./tags/java/">java</a>, <a href="./tags/google%20closure/">google closure</a>, <a href="./tags/api/">api</a></span>
    </header>
    <p>This is a pretty neat post, I’ll show you how to programmatically call <a href="https://github.com/google/closure-library">Google Closure</a> in Java. Closure is an amazing project that actually optimizes <code>JavaScript</code> rather than just minifies it. (This is pretty much one of the few times you’ll see me write Java, I think the language sucks).</p>
<p>Its mostly a 2017 update of this <a href="http://blog.bolinfest.com/2009/11/calling-closure-compiler-from-java.html">post from 2009</a></p>
<p>Here’s the Java</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java"><span class="kw">package</span><span class="im"> com.hyegar.closure;</span>

<span class="kw">import</span><span class="im"> java.io.IOException;</span>
<span class="kw">import</span><span class="im"> java.util.List;</span>
<span class="kw">import</span><span class="im"> java.util.ArrayList;</span>

<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.CompilationLevel;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.Compiler;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.CompilerOptions;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.SourceFile;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.CommandLineRunner;</span>
<span class="kw">import</span><span class="im"> com.google.javascript.jscomp.CompilerOptions.LanguageMode;</span>

<span class="co">/**</span>
<span class="co"> * An example of how to call the Closure Compiler programmatically, </span>
<span class="co"> * this is LICENSED AS GPL-3.0.</span>
<span class="co"> *</span>
<span class="co"> * </span><span class="kw">@author </span><span class="co">edgar.factorial@gmail.com (Edgar Aroutiounian)</span>
<span class="co"> */</span>

<span class="kw">public</span> <span class="kw">class</span> CallCompiler {

    <span class="co">/**</span>
<span class="co">     * </span><span class="kw">@param code </span><span class="co">JavaScript source code to compile.</span>
<span class="co">     * </span><span class="kw">@return </span><span class="co">The compiled version of the code.</span>
<span class="co">     */</span>
    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> <span class="fu">compile</span>(<span class="bu">String</span> code) {
	<span class="bu">Compiler</span> compiler = <span class="kw">new</span> <span class="bu">Compiler</span>();

	CompilerOptions options = <span class="kw">new</span> <span class="fu">CompilerOptions</span>();

	<span class="co">// See :</span>
	<span class="co">// closure-compiler/src/com/google/javascript/jscomp/CompilerOptions.java</span>
	<span class="co">// lines 2864-2896</span>
	options.<span class="fu">setLanguageIn</span>(LanguageMode.<span class="fu">ECMASCRIPT_2015</span>);
	options.<span class="fu">setLanguageOut</span>(LanguageMode.<span class="fu">ECMASCRIPT5_STRICT</span>);

	CompilationLevel
	    .<span class="fu">ADVANCED_OPTIMIZATIONS</span>
	    .<span class="fu">setOptionsForCompilationLevel</span>(options);

	<span class="bu">List</span>&lt;SourceFile&gt; list = <span class="kw">null</span>;

	<span class="kw">try</span> {
	    list =
		CommandLineRunner
		.<span class="fu">getBuiltinExterns</span>(CompilerOptions.<span class="fu">Environment</span>.<span class="fu">BROWSER</span>);
	} <span class="kw">catch</span> (<span class="bu">IOException</span> e) {
	    <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Exception raised&quot;</span>);
	}

	list.<span class="fu">add</span>(SourceFile.<span class="fu">fromCode</span>(<span class="st">&quot;input.js&quot;</span>, code));
	compiler.<span class="fu">compile</span>(<span class="kw">new</span> <span class="bu">ArrayList</span>&lt;SourceFile&gt;(), list, options);
	<span class="kw">return</span> compiler.<span class="fu">toSource</span>();
    }

    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(<span class="bu">String</span>[] args) {
      <span class="bu">String</span> compiled_code = <span class="fu">compile</span>(<span class="st">&quot;var a = 1 + 2; console.log(a)&quot;</span>);
      <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(compiled_code);
    }

}</code></pre></div>
<p>You’ll need to have the Closure Compiler installed, on OS X this is easy with <code>brew install closure-compiler</code></p>
<p>Then in a new directory that you can use for this build, you can copy the <code>jar</code> from <code>/usr/local/Cellar/closure-compiler/20161201/libexec</code> to where the root is of your directory, let’s call that directory <code>build</code>.</p>
<p>Here’s a Makefile which will build, run the code.</p>
<div class="sourceCode"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span class="dv">blog_code:</span>
	javac -Xlint:deprecation -cp ./closure-compiler-v20161201.jar:./ com/hyegar/closure/CallCompiler.java
	java -cp ./closure-compiler-v20161201.jar:./ com.hyegar.closure.CallCompiler	</code></pre></div>
</article>
<article>
    <header>
        <h1>
            <a href="./2017/01/08/variants-in-cpp/" title="Permalink">
                variants in C++14 without boost
            </a>
        </h1>
        <span class="post-date">January  8, 2017</span> in 
        <span class="post-tags"><a href="./tags/variants/">variants</a>, <a href="./tags/C%2B%2B/">C++</a>, <a href="./tags/C%2B%2B14/">C++14</a></span>
    </header>
    <h1 id="variants-in-their-native-land">Variants in their native land</h1>
<p>One of the best parts of functional programming are <code>Algebraic Data Types</code>, also known as <code>Sum</code> types, also known as <code>variants</code>. They help you make more type safe programs, self-documenting code.</p>
<p>Here are some examples in <code>OCaml</code></p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">type</span> 'a <span class="dt">option</span> = <span class="dt">Some</span> <span class="kw">of</span> 'a | <span class="dt">None</span></code></pre></div>
<p>This is the famous option type of functional programming. A fun thing about option is that its also a Monad, so <code>&gt;&gt;=</code> aka <code>bind</code> is easily defined as:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> ( &gt;&gt;= ) x f = <span class="kw">match</span> x <span class="kw">with</span> <span class="dt">Some</span> h -&gt; f h | _ -&gt; <span class="dt">None</span></code></pre></div>
<p>Another example recently added to the OCaml standard library is the result type.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">type</span> ('success, 'failure) result = Ok <span class="kw">of</span> 'success | Error <span class="kw">of</span> 'failure</code></pre></div>
<p>The things prefixed with <code>'</code> are called type variables, they let you write generic code from the getgo. We only need one for <code>option</code> but we need two different ones for result so that the type of the <code>Ok</code> variant need not be the same as the type of the <code>Error</code> variant.</p>
<p>Once you get an <code>result</code> value, you can pattern match on it:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> process_result = <span class="kw">function</span> 
  | Ok r -&gt; <span class="co">(* Do something with r *)</span>
  | Error reason -&gt; <span class="co">(* Do something with the error *)</span></code></pre></div>
<h1 id="variants-in-c">variants in C++</h1>
<p>In <code>C++</code> variants are not first class citizens of the language, so they need to be provided by a library. In modern <code>C++</code> our options are <code>C++17</code>’s <code>std::variant</code>, <code>boost::variant</code> or someone’s own rolled version.</p>
<p>I don’t want the <code>boost</code> dependency and I can’t use <code>C++17</code> so I looked for a library implementation. I found one by <a href="https://github.com/mapbox/variant">mapbox</a> and it fit my usecase perfectly; its a header only template library and I like the API provided. Here’s my implementation of <code>option</code> using the <code>mapbox</code> variant library.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// Let's assume this file is named optional.hpp</span>
<span class="pp">#pragma once</span>

<span class="pp">#include </span><span class="im">&lt;mapbox/variant.hpp&gt;</span>

<span class="kw">namespace</span> optional {
  <span class="kw">struct</span> None { };
  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;
  <span class="kw">struct</span> Some { T payload; };

  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;
  <span class="kw">struct</span> Optional : mapbox::util::variant&lt;None, Some&lt;T&gt;&gt; {
    <span class="kw">using</span> Base = mapbox::util::variant&lt;None, Some&lt;T&gt;&gt;;
    <span class="kw">using</span> Base::Base;
  };

  <span class="co">// These two are helper functions, like std::make_unique, etc.</span>
  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;
  <span class="kw">auto</span> some(T x)  { <span class="cf">return</span> Optional&lt;T&gt;{Some&lt;T&gt;{x}}; }

  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;
  <span class="kw">auto</span> none(<span class="dt">void</span>) { <span class="cf">return</span> Optional&lt;T&gt;{None{}}; }

}</code></pre></div>
<p>And here’s an example usage:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">// Let's assume this file is named main.cpp</span>
<span class="pp">#include </span><span class="im">&lt;string&gt;</span>
<span class="pp">#include </span><span class="im">&lt;iostream&gt;</span>

<span class="pp">#include </span><span class="im">&quot;optional.hpp&quot;</span>

<span class="co">// This lets just make std::string just by adding a suffix of 's'</span>
<span class="co">// to things that otherwise look like char *</span>
<span class="kw">using</span> <span class="kw">namespace</span> <span class="bu">std::</span>literals<span class="bu">::</span>string_literals;

<span class="co">// Pretend that this is something that could fail.</span>
<span class="kw">auto</span> file_contents(<span class="dt">void</span>) {
  <span class="cf">return</span> optional::some(<span class="st">&quot;some file contents&quot;</span>s);
}

<span class="dt">int</span> main(<span class="dt">void</span>)
{
  file_contents()
    .match(
  	   [](optional::None) {
  	     <span class="bu">std::</span>cout &lt;&lt; <span class="st">&quot;Check if file existed</span><span class="sc">\n</span><span class="st">&quot;</span>;
  	   },
  	   [](<span class="kw">auto</span> some) {
  	     <span class="bu">std::</span>cout &lt;&lt; <span class="st">&quot;File contents: &quot;</span> &lt;&lt; some.payload;
  	   });
}</code></pre></div>
<p>and you can easily compile it with, assuming that you added mapbox/variant.hpp to your compiler’s include search path…</p>
<pre class="shell"><code>$ clang++ -std=c++14 main.cpp</code></pre>
<p>Happy coding.</p>
</article>
<article>
    <header>
        <h1>
            <a href="./2016/12/23/async-promises-node/" title="Permalink">
                node's async, await, Promises.
            </a>
        </h1>
        <span class="post-date">December 23, 2016</span> in 
        <span class="post-tags"><a href="./tags/async/">async</a>, <a href="./tags/lwt/">lwt</a>, <a href="./tags/await/">await</a>, <a href="./tags/async/">async</a>, <a href="./tags/promises/">promises</a></span>
    </header>
    <p>While studying for interviews I’m talking breaks by working on <a href="https://github.com/fxfactorial/silicondzor">silicondzor.com</a></p>
<p>This is giving me some real web dev experience and I’m using the latest and greatest features of <code>JavaScript</code> and <code>node</code>.</p>
<p>One thing that I’m really liking in modern <code>JavaScript</code> is the <code>async</code> story, it reminds me a lot of <code>OCaml</code> and both are somewhat converging, i.e <code>ES6</code>’s introduction of Promises which are basically <code>'a Lwt.t</code>, and Lwt renaming <code>Lwt.t</code> into Promises in <code>2.7.0</code>.</p>
<p>Here’s like my conceptual cheatsheet about using <code>Promises</code> from scratch, converting an callback API into a <code>Promises</code> API and then taking it to the next step with <code>async</code>, <code>await</code>.</p>
<h1 id="basic-callback-apis">Basic callback APIs</h1>
<p><code>node</code> uses an event based programming paradigm and this is reflected in basically all server side code, ie the trailing callback argument to asynchronously call once the task completes.</p>
<p>Let’s simulate it with this function</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Plain CB based API</span>
<span class="kw">const</span> test_func <span class="op">=</span> (item<span class="op">,</span> cb) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="at">setTimeout</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (item <span class="op">&lt;</span> <span class="dv">5</span>) <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="st">'Success'</span>)<span class="op">;</span>
    <span class="cf">else</span> <span class="at">cb</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">'Oops'</span>)<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span>
  <span class="op">},</span> <span class="dv">3000</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="at">test_func</span>(<span class="dv">3</span><span class="op">,</span> (err<span class="op">,</span> success) <span class="op">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(success))<span class="op">;</span></code></pre></div>
<p>This models typical <code>node</code> code, the callback being called <code>three</code> seconds after execution of <code>test_func</code></p>
<p>This seems pretty fine for this example but once you have logic that is dependent on the success of one callback API after another then you start to have a difficult to reason about triangle of callbacks on the screen.</p>
<h1 id="promises">Promises</h1>
<p><code>ES6</code> introduces <code>Promises</code> and these are quite convienent, think of a Promise as being a box which will have a value in it sometime later.</p>
<p>We can turn any callback based API into a Promises based one.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Promises based</span>
<span class="kw">const</span> test_func_promise <span class="op">=</span> item <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((accept<span class="op">,</span> reject) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">test_func</span>(item<span class="op">,</span> (err<span class="op">,</span> success) <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="cf">if</span> (err) <span class="at">reject</span>(err)<span class="op">;</span>
      <span class="cf">else</span> <span class="at">accept</span>(success)<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="at">test_func_promise</span>(<span class="dv">2</span>)
.<span class="at">then</span>(item <span class="op">=&gt;</span> <span class="op">{</span> <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Sucess!!'</span><span class="op">,</span> item)<span class="op">;</span> <span class="op">}</span>)
.<span class="at">catch</span>(err <span class="op">=&gt;</span> <span class="va">console</span>.<span class="at">error</span>(err))<span class="op">;</span></code></pre></div>
<p>When you create a new <code>Promise</code> you need to provide it with two function, one to be called when there’s a success and when the Promise should fail. Hence when calling <code>test_func_promise</code> returns a Promise, not the value <code>'Success'</code>. Also if you use the plain Promises approach be sure to include a <code>.catch</code> call.</p>
<p>This is nicer than the original callback API approach, but now all your success or failure logic and everything following that effectively has to be all in either <code>.then</code> or <code>.catch</code> and that’s a bit awkward still.</p>
<h1 id="asyncawait">async/await</h1>
<p><code>ES7</code> introduced <code>async</code>, <code>await</code> where I basically think of the latter as <code>&gt;&gt;=</code> and <code>async</code> as sort of like <code>&gt;|=</code>. With <code>async</code>, <code>await</code> we can call <code>Promises</code> based code as if it was synchronous code.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">const</span> test_func_async_example <span class="op">=</span> <span class="at">async</span> (item) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="cf">try</span> <span class="op">{</span>
    <span class="kw">const</span> result <span class="op">=</span> await <span class="at">test_func_promise</span>(item)<span class="op">;</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Yay: </span><span class="sc">${</span>result<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">catch</span>(e) <span class="op">{</span>
    <span class="va">console</span>.<span class="at">error</span>(<span class="vs">`Messed up: </span><span class="sc">${</span>e<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span>

<span class="at">test_func_async_example</span>(<span class="dv">6</span>)<span class="op">;</span>
<span class="at">test_func_async_example</span>(<span class="dv">3</span>)<span class="op">;</span></code></pre></div>
<p>First notice how whatever function we use <code>await</code> inside of, we need to tag that function with <code>async</code> and now this function returns a <code>Promise</code></p>
<p>Now when we call <code>test_func_promises</code> with <code>await</code> prefixed, then we get the value that the <code>Promise</code> resolved. Also whatever the <code>reject</code> condition of the <code>Promise</code> was then becomes the exception of the <code>catch</code> following the <code>await</code> usage.</p>
<h1 id="summary">Summary</h1>
<p><code>async</code>, <code>await</code> are very powerful features of <code>ES7</code>, <code>Promises</code> are from <code>ES6</code>. Not every <code>JavaScript</code> engine supports <code>ES7</code> so you’ll have to use <code>babel</code> to compile your <code>async</code>, <code>await</code> to runnable code; basically turns the <code>async</code>, <code>await</code> to generators (also an amazing topic).</p>
<p>On newer versions of node, I’m using <code>v7.3.0</code>, you can turn on features from the future with command line arguments. Check all of them with:</p>
<pre><code>$ node --v8-options | less</code></pre>
<p>I’m turning on native <code>async</code>, <code>await</code> with <code>--harmony_async_await</code>, so my final invocation is:</p>
<pre><code>$ node --harmony_async_await test.js</code></pre>
<p>You can get all the code as one script <a href="https://gist.github.com/fxfactorial/60edd7c3c8948754d21dbc9f517e37ee">here</a></p>
</article>
<article>
    <header>
        <h1>
            <a href="./2016/11/03/using-javascriptcore/" title="Permalink">
                Using JavaScriptCore with examples
            </a>
        </h1>
        <span class="post-date">November  3, 2016</span> in 
        <span class="post-tags"><a href="./tags/javascriptcore/">javascriptcore</a>, <a href="./tags/javascript/">javascript</a></span>
    </header>
    <h2 id="motivation">Motivation</h2>
<p>I like mixing languages and I especially like <code>OCaml</code>, <code>JavaScript</code>. Lately I’ve been writing <code>OCaml</code> bindings to <code>JavaScriptCore</code>, JSC is what underpins Safari both iOS and desktop variants, and ReactNative. When you’re writing bindings, you kinda need to know the <code>C/C++</code> library that you’re binding to.</p>
<h2 id="example">Example</h2>
<p>We’re going to provide a pretty meaty example, we’ll make a custom object in C++ code, then we’ll use it from a <code>JavaScript</code> script. Imagine we want to expose a <code>File</code> like object, JS the language itself has no notion of a File, so it will need support from the C/C++ level; you can imagine this as the objects that say <code>[native code]</code>.</p>
<p>Here’s the code, afterwards is a detailed breakdown (The <code>R</code> C++ feature confuses the syntax highlighter)</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="pp">#include </span><span class="im">&lt;string&gt;</span>
<span class="pp">#include </span><span class="im">&lt;iostream&gt;</span>
<span class="pp">#include </span><span class="im">&lt;JavaScriptCore/JavaScriptCore.h&gt;</span>

<span class="bu">std::</span>string getcwd_string(<span class="dt">void</span>)
{
   <span class="dt">char</span> buff[PATH_MAX];
   getcwd(buff, PATH_MAX);
   <span class="bu">std::</span>string cwd(buff);
   <span class="cf">return</span> cwd;
}

<span class="at">const</span> <span class="dt">char</span>*
jsvalue_to_utf8_string(JSGlobalContextRef ctx, JSValueRef v)
{
  JSStringRef valueAsString = JSValueToStringCopy(ctx, v, NULL);
  <span class="dt">size_t</span> jsSize = JSStringGetMaximumUTF8CStringSize(valueAsString);
  <span class="dt">char</span>* jsBuffer = (<span class="dt">char</span>*)malloc(jsSize);
  JSStringGetUTF8CString(valueAsString, jsBuffer, jsSize);
  JSStringRelease(valueAsString);
  <span class="cf">return</span> jsBuffer;
}

<span class="dt">void</span> run_example(<span class="dt">void</span>)
{
  JSClassDefinition definition = kJSClassDefinitionEmpty;
  definition.className = <span class="st">&quot;File&quot;</span>;
  definition.callAsConstructor = [](<span class="kw">auto</span> ctx,
				    <span class="kw">auto</span> object,
				    <span class="kw">auto</span> argumentCount,
				    <span class="kw">auto</span> arguments[],
				    <span class="kw">auto</span> *exception) -&gt; JSObjectRef {
    <span class="kw">auto</span> file_name =
    JSValueMakeString(ctx, JSStringCreateWithUTF8CString(getcwd_string().c_str()));
    <span class="kw">auto</span> prop_name = JSStringCreateWithUTF8CString(<span class="st">&quot;cwdName&quot;</span>);
    <span class="kw">auto</span> example_obj = JSObjectMake(ctx, <span class="kw">nullptr</span>, <span class="kw">nullptr</span>);

    JSObjectSetProperty(ctx,
			example_obj,
			prop_name,
			file_name,
			kJSPropertyAttributeNone,
			<span class="kw">nullptr</span>);
    <span class="cf">return</span> example_obj;
  };

  <span class="kw">auto</span> ctx = JSGlobalContextCreate(<span class="kw">nullptr</span>);
  <span class="kw">auto</span> js_example_class = JSClassCreate(&amp;definition);
  <span class="kw">auto</span> example_obj = JSObjectMake(ctx, js_example_class, <span class="kw">nullptr</span>);
  <span class="co">// auto called_result = JSObjectCallAsConstructor(ctx, example_obj, 0, nullptr, nullptr);</span>
  <span class="co">// auto property_check =</span>
  <span class="co">//   JSObjectGetProperty(ctx,</span>
  <span class="co">// 			called_result,</span>
  <span class="co">// 			JSStringCreateWithUTF8CString(&quot;cwdName&quot;),</span>
  <span class="co">// 			nullptr);</span>

  <span class="co">// std::cout &lt;&lt; jsvalue_to_utf8_string(ctx, property_check) &lt;&lt; std::endl;</span>
  <span class="bu">std::</span>string code_to_eval = <span class="st">R&quot;(</span>
<span class="st">const example_code = new File;</span>
<span class="st">example_code.cwdName;</span>
<span class="st">)&quot;;</span>
<span class="st">  JSValueRef exn;</span>

<span class="st">  auto global_object = JSContextGetGlobalObject(ctx);</span>
<span class="st">  JSObjectSetProperty(ctx,</span>
<span class="st">		      global_object,</span>
<span class="st">		      JSStringCreateWithUTF8CString(&quot;File&quot;),</span>
<span class="st">		      example_obj,</span>
<span class="st">		      kJSPropertyAttributeNone,</span>
<span class="st">		      nullptr);</span>

<span class="st">  auto sanity_check =</span>
<span class="st">    JSEvaluateScript(ctx,</span>
<span class="st">		     JSStringCreateWithUTF8CString(code_to_eval.c_str()),</span>
<span class="st">		     nullptr,</span>
<span class="st">		     nullptr,</span>
<span class="st">		     1,</span>
<span class="st">		     &amp;exn);</span>
<span class="st">  if (exn)</span>
<span class="st">    std::cout &lt;&lt; jsvalue_to_utf8_string(ctx, exn) &lt;&lt; std::endl;</span>

<span class="st">  std::cout &lt;&lt; jsvalue_to_utf8_string(ctx, sanity_check) &lt;&lt; std::endl;</span>
<span class="st">}</span>

<span class="st">int main(int argc, char **argv)</span>
<span class="st">{</span>
<span class="st">  run_example();</span>
<span class="st">  return 0;</span>
<span class="st">}</span></code></pre></div>
<p>compile with, should work just fine on Linux as well, but using:</p>
<p><code>libjavascriptcoregtk-4.0</code> instead of the <code>-framework JavaScriptCore</code></p>
<pre class="shell"><code>$ clang++ -framework JavaScriptCore -std=c++14 jsc_examples.cpp -oF </code></pre>
<h2 id="explanations">Explanations</h2>
<p>The real meat of the code starts at <code>run_example</code>. We start by creating a <code>JSClassDefinition</code>, this creates a template that lets us control all the behavior of our custom object. Then we provide an implementation for what code ought to be run when our custom object will created with <code>new</code>, notice using <code>C++14</code>’s nice ability to use <code>auto</code> for the parameter names, also notice that we explicitly have to give back the return type of <code>JSObjectRef</code>, you get a bit spoiled by the <code>OCaml</code> type system. Then we create a <code>JavaScript</code> object, set the property <code>cwdName</code> and return that new object from the constructor call.</p>
<p>Then we need to make a global context, this is like the environment that your JavaScript runs in and we grab the global object out of it, like <code>window</code> in the browser. (The commented out code is if you wanted to call the constructor and get the result directly in code)</p>
<p>We set the class object as a property to the global, aka like doing <code>window.d3 = //d3's code</code>. Then we evaluate a script, some fun trival all your <code>&lt;script&gt;</code> tags actually have a return value, its the last value.</p>
<p>Tada.</p>
<p>FWIW I’m doing the OCaml bindings <a href="https://github.com/fxfactorial/ocaml-javascriptcore">here</a> github stars appreciated :)</p>
</article>


<footer>
    See older posts in the <a href="./archive/">archive</a>
</footer>

    </section>

    <footer id="page_footer">
    <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC-4.0</a>
    &mdash;
    Built with 
    <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
    &mdash;
    Source on 
    <a href="https://github.com/fxfactorial/hblog">GitHub</a>
    &mdash;
    <a href="http://hyegar.com/atom.xml">RSS feed</a>
</footer>

  </body>
</html>
