<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Personal blog of Edgar Aroutiounian">
    <meta name="author" content="Edgar Aroutiounian">
    <title>hyegar.com - node's async, await, Promises.</title>
    <link rel="canonical" href="http://hyegar.com">
    <link rel="icon" href="../../../../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="../../../../css/main.css">
    <link href="../../../../atom.xml" rel="alternate" title="hyegar.com - A personal and developer blog" type="application/atom+xml">
    <link type="text/plain" rel="author" href="../../../../humans.txt">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-57031124-1', 'auto');
      ga('send', 'pageview');
    </script>

  </head>

  <body>
    <header id="page_header">
    <h1><a href="../../../../" title="Home">Edgar Aroutiounian</a></h1>
</header>

    <nav id="page_navigation">
    <ul>
        <li><a href="../../../../">Home</a></li>
        <li><a href="../../../../about">About</a></li>
        <li><a href="../../../../archive">Archive</a></li>
        <li><a href="../../../../resume">Resume</a></li>
    </ul>
</nav>

    
    <section id="content">
      <article>
    <header>
        <h1>node's async, await, Promises.</h1>
        <span class="post-date">December 23, 2016</span> in 
        <span class="post-tags"><a href="../../../../tags/async/">async</a>, <a href="../../../../tags/lwt/">lwt</a>, <a href="../../../../tags/await/">await</a>, <a href="../../../../tags/async/">async</a>, <a href="../../../../tags/promises/">promises</a></span>
    </header>
    <p>While studying for interviews I’m talking breaks by working on <a href="https://github.com/fxfactorial/silicondzor">silicondzor.com</a></p>
<p>This is giving me some real web dev experience and I’m using the latest and greatest features of <code>JavaScript</code> and <code>node</code>.</p>
<p>One thing that I’m really liking in modern <code>JavaScript</code> is the <code>async</code> story, it reminds me a lot of <code>OCaml</code> and both are somewhat converging, i.e <code>ES6</code>’s introduction of Promises which are basically <code>'a Lwt.t</code>, and Lwt renaming <code>Lwt.t</code> into Promises in <code>2.7.0</code>.</p>
<p>Here’s like my conceptual cheatsheet about using <code>Promises</code> from scratch, converting an callback API into a <code>Promises</code> API and then taking it to the next step with <code>async</code>, <code>await</code>.</p>
<h1 id="basic-callback-apis">Basic callback APIs</h1>
<p><code>node</code> uses an event based programming paradigm and this is reflected in basically all server side code, ie the trailing callback argument to asynchronously call once the task completes.</p>
<p>Let’s simulate it with this function</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Plain CB based API</span>
<span class="kw">const</span> test_func <span class="op">=</span> (item<span class="op">,</span> cb) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="at">setTimeout</span>(() <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="cf">if</span> (item <span class="op">&lt;</span> <span class="dv">5</span>) <span class="at">cb</span>(<span class="kw">null</span><span class="op">,</span> <span class="st">'Success'</span>)<span class="op">;</span>
    <span class="cf">else</span> <span class="at">cb</span>(<span class="kw">new</span> <span class="at">Error</span>(<span class="st">'Oops'</span>)<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span>
  <span class="op">},</span> <span class="dv">3000</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="at">test_func</span>(<span class="dv">3</span><span class="op">,</span> (err<span class="op">,</span> success) <span class="op">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(success))<span class="op">;</span></code></pre></div>
<p>This models typical <code>node</code> code, the callback being called <code>three</code> seconds after execution of <code>test_func</code></p>
<p>This seems pretty fine for this example but once you have logic that is dependent on the success of one callback API after another then you start to have a difficult to reason about triangle of callbacks on the screen.</p>
<h1 id="promises">Promises</h1>
<p><code>ES6</code> introduces <code>Promises</code> and these are quite convienent, think of a Promise as being a box which will have a value in it sometime later.</p>
<p>We can turn any callback based API into a Promises based one.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Promises based</span>
<span class="kw">const</span> test_func_promise <span class="op">=</span> item <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((accept<span class="op">,</span> reject) <span class="op">=&gt;</span> <span class="op">{</span>
    <span class="at">test_func</span>(item<span class="op">,</span> (err<span class="op">,</span> success) <span class="op">=&gt;</span> <span class="op">{</span>
      <span class="cf">if</span> (err) <span class="at">reject</span>(err)<span class="op">;</span>
      <span class="cf">else</span> <span class="at">accept</span>(success)<span class="op">;</span>
    <span class="op">}</span>)<span class="op">;</span>
  <span class="op">}</span>)<span class="op">;</span>
<span class="op">};</span>

<span class="at">test_func_promise</span>(<span class="dv">2</span>)
.<span class="at">then</span>(item <span class="op">=&gt;</span> <span class="op">{</span> <span class="va">console</span>.<span class="at">log</span>(<span class="st">'Sucess!!'</span><span class="op">,</span> item)<span class="op">;</span> <span class="op">}</span>)
.<span class="at">catch</span>(err <span class="op">=&gt;</span> <span class="va">console</span>.<span class="at">error</span>(err))<span class="op">;</span></code></pre></div>
<p>When you create a new <code>Promise</code> you need to provide it with two function, one to be called when there’s a success and when the Promise should fail. Hence when calling <code>test_func_promise</code> returns a Promise, not the value <code>'Success'</code>. Also if you use the plain Promises approach be sure to include a <code>.catch</code> call.</p>
<p>This is nicer than the original callback API approach, but now all your success or failure logic and everything following that effectively has to be all in either <code>.then</code> or <code>.catch</code> and that’s a bit awkward still.</p>
<h1 id="asyncawait">async/await</h1>
<p><code>ES7</code> introduced <code>async</code>, <code>await</code> where I basically think of the latter as <code>&gt;&gt;=</code> and <code>async</code> as sort of like <code>&gt;|=</code>. With <code>async</code>, <code>await</code> we can call <code>Promises</code> based code as if it was synchronous code.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">const</span> test_func_async_example <span class="op">=</span> <span class="at">async</span> (item) <span class="op">=&gt;</span> <span class="op">{</span>
  <span class="cf">try</span> <span class="op">{</span>
    <span class="kw">const</span> result <span class="op">=</span> await <span class="at">test_func_promise</span>(item)<span class="op">;</span>
    <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Yay: </span><span class="sc">${</span>result<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>
  <span class="op">}</span> <span class="cf">catch</span>(e) <span class="op">{</span>
    <span class="va">console</span>.<span class="at">error</span>(<span class="vs">`Messed up: </span><span class="sc">${</span>e<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>
  <span class="op">}</span>
<span class="op">};</span>

<span class="at">test_func_async_example</span>(<span class="dv">6</span>)<span class="op">;</span>
<span class="at">test_func_async_example</span>(<span class="dv">3</span>)<span class="op">;</span></code></pre></div>
<p>First notice how whatever function we use <code>await</code> inside of, we need to tag that function with <code>async</code> and now this function returns a <code>Promise</code></p>
<p>Now when we call <code>test_func_promises</code> with <code>await</code> prefixed, then we get the value that the <code>Promise</code> resolved. Also whatever the <code>reject</code> condition of the <code>Promise</code> was then becomes the exception of the <code>catch</code> following the <code>await</code> usage.</p>
<h1 id="summary">Summary</h1>
<p><code>async</code>, <code>await</code> are very powerful features of <code>ES7</code>, <code>Promises</code> are from <code>ES6</code>. Not every <code>JavaScript</code> engine supports <code>ES7</code> so you’ll have to use <code>babel</code> to compile your <code>async</code>, <code>await</code> to runnable code; basically turns the <code>async</code>, <code>await</code> to generators (also an amazing topic).</p>
<p>On newer versions of node, I’m using <code>v7.3.0</code>, you can turn on features from the future with command line arguments. Check all of them with:</p>
<pre><code>$ node --v8-options | less</code></pre>
<p>I’m turning on native <code>async</code>, <code>await</code> with <code>--harmony_async_await</code>, so my final invocation is:</p>
<pre><code>$ node --harmony_async_await test.js</code></pre>
<p>You can get all the code as one script <a href="https://gist.github.com/fxfactorial/60edd7c3c8948754d21dbc9f517e37ee">here</a></p>
</article>

    </section>

    <footer id="page_footer">
    <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC-4.0</a>
    &mdash;
    Built with 
    <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
    &mdash;
    Source on 
    <a href="https://github.com/fxfactorial/hblog">GitHub</a>
    &mdash;
    <a href="http://hyegar.com/atom.xml">RSS feed</a>
</footer>

  </body>
</html>
