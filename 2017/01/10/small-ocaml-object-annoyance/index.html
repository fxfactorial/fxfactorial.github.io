<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Personal blog of Edgar Aroutiounian">
    <meta name="author" content="Edgar Aroutiounian">
    <title>hyegar.com - let binding in OCaml class definition</title>
    <link rel="canonical" href="http://hyegar.com">
    <link rel="icon" href="../../../../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="../../../../css/main.css">
    <link href="../../../../atom.xml" rel="alternate" title="hyegar.com - A personal and developer blog" type="application/atom+xml">
    <link type="text/plain" rel="author" href="../../../../humans.txt">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-57031124-1', 'auto');
      ga('send', 'pageview');
    </script>

  </head>

  <body>
    <header id="page_header">
    <h1><a href="../../../../" title="Home">Edgar Aroutiounian</a></h1>
</header>

    <nav id="page_navigation">
    <ul>
        <li><a href="../../../../">Home</a></li>
        <li><a href="../../../../about">About</a></li>
        <li><a href="../../../../archive">Archive</a></li>
        <li><a href="../../../../resume">Resume</a></li>
    </ul>
</nav>

    
    <section id="content">
      <article>
    <header>
        <h1>let binding in OCaml class definition</h1>
        <span class="post-date">January 10, 2017</span> in 
        <span class="post-tags"><a href="../../../../tags/ocaml/">ocaml</a>, <a href="../../../../tags/objects/">objects</a>, <a href="../../../../tags/mistakes/">mistakes</a></span>
    </header>
    <p>I like the <code>object</code> layer in OCaml but here’s one quirk of the language that sometimes I forget about and it can bite you…like I just got bit in my <code>OCaml</code> <a href="https://github.com/fxfactorial/ocaml-java-scriptengine">bindings</a> to <code>Java</code>’s <code>ScriptEngine</code>. (Let’s you evaluate <code>JavaScript</code> in <code>OCaml</code> using the JVM)</p>
<p>OCaml lets you define an object like so:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing = <span class="kw">object</span>
  <span class="kw">method</span> speak = <span class="dt">print_endline</span> <span class="st">&quot;Hello&quot;</span>
<span class="kw">end</span>

<span class="kw">let</span> () = (<span class="kw">new</span> thing)#speak</code></pre></div>
<p>Note that <code>method</code>s don’t need arguments, they will always go off when you call them.</p>
<p>and you can also have fields</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing = <span class="kw">object</span>
  <span class="kw">val</span> coder = <span class="st">&quot;coder&quot;</span>
  <span class="kw">val</span> <span class="kw">mutable</span> name = <span class="st">&quot;Edgar&quot;</span>

  <span class="kw">method</span> speak = <span class="dt">print_endline</span> (name ^ coder)
  <span class="kw">method</span> set_name s = name &lt;- s
<span class="kw">end</span>

<span class="kw">let</span> () = 
  <span class="kw">let</span> p = <span class="kw">new</span> thing <span class="kw">in</span>
  p#speak;
  p#set_name <span class="st">&quot;Gohar&quot;</span>;
  p#speak</code></pre></div>
<p>Notice that we can also make fields <code>mutable</code> and they are private by default.</p>
<p>Now here’s one situation you might encounter:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> compute = <span class="kw">object</span>
  <span class="kw">val</span> first_field = Other_module.init ()
  <span class="kw">val</span> second_field = Some_module.use_it first_field
<span class="kw">end</span></code></pre></div>
<p>This won’t work though because you can’t use one field in another field.</p>
<p>One solution might be:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml">
<span class="kw">class</span> compute = 

  <span class="kw">let</span> first_field = Other_module.init () <span class="kw">in</span>
  <span class="kw">let</span> second_field = Some_module.use_it first_field <span class="kw">in</span>
  <span class="kw">object</span>
    <span class="kw">val</span> first = first_field
    <span class="kw">val</span> second = second_field
  <span class="kw">end</span></code></pre></div>
<p>Now question, are <code>first_field</code> and <code>second_field</code> created each time a new instance of <code>compute</code> is made?</p>
<p>…</p>
<p>The answer is no and this might be counter intuitive to some, at least it was to me and I sometimes forget this.</p>
<p>Verify it with:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> thing =
  <span class="kw">let</span> foo = <span class="dv">1</span> + <span class="dv">2</span> <span class="kw">in</span>
  <span class="kw">let</span> () = <span class="dt">print_endline</span> <span class="st">&quot;I was called&quot;</span> <span class="kw">in</span>
  <span class="kw">object</span>

  <span class="kw">end</span>


<span class="kw">let</span> () =
  <span class="kw">let</span> a = <span class="kw">new</span> thing <span class="kw">in</span>
  <span class="kw">let</span> b = <span class="kw">new</span> thing <span class="kw">in</span>
  ()</code></pre></div>
<p>And see how many times <code>I was called</code> is printed to the screen; hence be aware of this when you use objects in OCaml.</p>
</article>

    </section>

    <footer id="page_footer">
    <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC-4.0</a>
    &mdash;
    Built with 
    <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
    &mdash;
    Source on 
    <a href="https://github.com/fxfactorial/hblog">GitHub</a>
    &mdash;
    <a href="http://hyegar.com/atom.xml">RSS feed</a>
</footer>

  </body>
</html>
